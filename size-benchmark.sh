#!/usr/bin/env bash

# set safe shell mode
set -euo pipefail

modes=("ReleaseSmall" "ReleaseFast" "ReleaseSafe" "Debug")

echo "# Size benchmark" >SIZE_BENCHMARK.md
echo "" >>SIZE_BENCHMARK.md
echo "This document contains the size in bytes of the firmware for each optimize mode." >>SIZE_BENCHMARK.md
echo "" >>SIZE_BENCHMARK.md
echo '`Failed` means that the firmware is too large to fit in the flash memory.' >>SIZE_BENCHMARK.md
echo "" >>SIZE_BENCHMARK.md

build() {
  local optimize="$1"
  local dir="$2"

  rm -rf "${dir}/zig-out"

  (cd "${dir}" && zig build -Doptimize="$optimize" || true)

  local size=$(stat -c %s "${dir}/zig-out/firmware/ch32v003_blink.bin" || echo "Failed")
  echo $size
}

for dir in */; do
  if [ ! -f "${dir}build.zig" ]; then
    continue
  fi

  dir=${dir//\//}

  echo "## ${dir}" >>SIZE_BENCHMARK.md
  echo "" >>SIZE_BENCHMARK.md

  for mode in "${modes[@]}"; do
    printf "| %s " "$mode" >>SIZE_BENCHMARK.md
  done
  printf "|\n" >>SIZE_BENCHMARK.md

  for mode in "${modes[@]}"; do
    printf "|--------" >>SIZE_BENCHMARK.md
  done
  printf "|\n" >>SIZE_BENCHMARK.md

  for mode in "${modes[@]}"; do
    size=$(build "$mode" "$dir")
    printf "| %s " "$size" >>SIZE_BENCHMARK.md
  done
  printf "|\n\n" >>SIZE_BENCHMARK.md
done

echo 'This document was generated by `size-benchmark.sh` script.' >>SIZE_BENCHMARK.md
