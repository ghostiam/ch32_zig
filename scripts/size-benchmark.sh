#!/usr/bin/env bash

# set safe shell mode
set -euo pipefail

base_dir=$(dirname "$0")
root_dir=$(realpath "${base_dir}/..")

columns=("Mode" "Text" "Data" "Bss" "Total")
modes=("ReleaseSmall" "ReleaseFast" "ReleaseSafe" "Debug")

echo "# Size benchmark" >SIZE_BENCHMARK.md
echo "" >>SIZE_BENCHMARK.md
echo "This document contains the size in bytes of the firmware for each optimize mode." >>SIZE_BENCHMARK.md
echo "" >>SIZE_BENCHMARK.md

build() {
  local optimize="$1"
  local dir="$2"

  rm -rf "${dir}/zig-out"

  (cd "${dir}" && zig build -Doptimize="$optimize" || true)
}

write_size_per_fw() {
  local optimize="$1"
  local dir="$2/zig-out/firmware"

  for file in "${dir}"/*".elf"; do
    if [ ! -f "${file}" ]; then
      continue
    fi

    size=$(size "${file}" | tail -n1 | awk '{print $1 " | " $2 " | " $3 " | " ($1 + $2 + $3)}' || echo "- | - | - | Failed")
    file_name=$(basename "$file")
    echo "| $optimize | $size | " >>"tmp_size_per_fw_${file_name}.md"
  done
}

merge_size() {
  for file in tmp_size_per_fw_*.md; do
    if [ ! -f "$file" ]; then
      continue
    fi

    fw_name=$(basename "$file" | sed 's/tmp_size_per_fw_//; s/.md//')
    echo "### $fw_name " >>SIZE_BENCHMARK.md
    echo "" >>SIZE_BENCHMARK.md

    for column in "${columns[@]}"; do
      printf "| %s " "$column" >>SIZE_BENCHMARK.md
    done
    printf "|\n" >>SIZE_BENCHMARK.md

    for column in "${columns[@]}"; do
      printf "|--------" >>SIZE_BENCHMARK.md
    done
    printf "|\n" >>SIZE_BENCHMARK.md

    while IFS= read -r line; do
      echo "$line" >>SIZE_BENCHMARK.md
    done <"$file"

    echo "" >>SIZE_BENCHMARK.md
  done

  rm -f "tmp_size_per_fw_"*".md"
}

cd "$root_dir" || exit 1

for dir in "examples/"*/; do
  if [ ! -f "${dir}build.zig" ]; then
    continue
  fi

  dir=$(sed 's/\/$//' <<<"$dir")

  echo "## [${dir}](${dir})" >>SIZE_BENCHMARK.md
  echo "" >>SIZE_BENCHMARK.md

  for mode in "${modes[@]}"; do
    rm -rf "$dir/zig-out"
    build "$mode" "$dir"
    write_size_per_fw "$mode" "$dir"
  done

  merge_size "$dir"
  echo "" >>SIZE_BENCHMARK.md
done

echo "" >>SIZE_BENCHMARK.md
echo 'This document was generated by `size-benchmark.sh` script.' >>SIZE_BENCHMARK.md
